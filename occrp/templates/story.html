{% extends 'base.html' %}
{% block title %}OCCRP{% endblock %}
{% block content %}
<div class="row">
    <div class="col-sm-12">
        <h3>{{ story.title }}</h3>
        <p>Last update: {{ story.updated_at }}</p>
        <p><a class="btn btn-warning" href="{{ url_for('views.index')}}"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Return to stories list</a> </p>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
        <h3>Add an event and related people, organizations, and sources to this story</h3>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
    {% include 'partials/event_form.html' %}
    </div>
</div>

{% if story.events %}
<div class="row">
    <div class="col-md-12">
        <h3>Events</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="story-width">Title</th>
                    <th>Start date</th>
                    <th>End date</th>
                </tr>
            </thead>
            <tbody>
                {% for event in story.events %}
                    <tr class="detailsControl">
                        <td>{{ event.title }}</td>
                        {% if event.start_date_accuracy == 4 %}
                            <td>{{ event.start_date|format_date('%Y') }}</td>
                        {% elif event.start_date_accuracy == 3 %}
                            <td>{{ event.start_date|format_date('%B %Y')}}</td>
                        {% elif event.start_date_accuracy == 2 %}
                            <td>{{ event.start_date|format_date('%d %B %Y')}}</td>
                        {% elif event.start_date_accuracy == 1 %}
                            <td>{{ event.start_date|format_date('%d %B %Y %H:%M')}}</td>
                        {% endif %}
                        {% if event.end_date_accuracy == 4 %}
                            <td>{{ event.end_date|format_date('%Y') }}</td>
                        {% elif event.end_date_accuracy == 3 %}
                            <td>{{ event.end_date|format_date('%B %Y')}}</td>
                        {% elif event.end_date_accuracy == 2 %}
                            <td>{{ event.end_date|format_date('%d %B %Y')}}</td>
                        {% elif event.end_date_accuracy == 1 %}
                            <td>{{ event.end_date|format_date('%d %B %Y %H:%M')}}</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <td colspan='3' style='display: none;'>
                            <div class="row flyout-row">
                                {% include 'partials/fly_out.html' %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock %}
{% block extra_javascript %}
<script type="text/javascript">
    $(document).ready(function(e){
         // Use jQuery-UI autocomplete function.
        $("#person-input").autocomplete({
            // Set the source to an AJAX callback, which fires the person_autocomplete view.
            source: function (request, response) {
                jQuery.get("{{ url_for('views.person_autocomplete')}}", {
                    q: request.term
                }, function (data) {
                      // Return an array of strings as a response.
                      var person_names = []
                      if (data) {
                        $.each(data, function(index, value) {
                          person_names.push(value.name)
                        });
                      }
                      response(person_names);
                });
            },
            minLength: 1,
            select: function( event, ui ) {
              console.log("Selected: " + ui.item.value);
            }
        });
    });
</script>
{% endblock %}
